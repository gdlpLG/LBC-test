<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LBC Finder | Recherche Intelligente</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="manifest" href="/static/manifest.json">
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ”</text></svg>">
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/sw.js');
            });
        }
    </script>
</head>

<body>

    <header>
        <div class="logo" onclick="location.reload()">LBC <span>Finder</span></div>
        <div style="display:flex; gap:15px; align-items:center">
            <div class="user-menu"
                style="display:flex; align-items:center; gap:10px; padding:5px 15px; background:rgba(255,255,255,0.05); border-radius:20px; border:1px solid var(--border)">
                <span style="font-size:0.9rem; color:var(--text)">ğŸ‘¤ <strong>{{ username }}</strong></span>
                <a href="/logout"
                    style="font-size:0.8rem; color:var(--text-muted); text-decoration:none; padding-left:10px; border-left:1px solid var(--border)">DÃ©connexion</a>
            </div>
            <button class="btn-primary"
                style="background:var(--card-bg); color:var(--text); border:1px solid var(--border)"
                onclick="openGlobalSettings()">âš™ï¸ Configuration</button>
            <button class="btn-primary"
                style="background:var(--card-bg); color:var(--text); border:1px solid var(--border)"
                onclick="openHelpModal()">â“ Aide</button>
            <button class="btn-primary"
                style="background:var(--card-bg); color:var(--warning); border:1px solid var(--border)"
                onclick="openFeedbackModal()">ğŸ’¡ IdÃ©e/Bug</button>

            <!-- Mini Log Terminal in Header -->
            <div id="header-log-mini" style="
                font-family: 'Consolas', monospace; 
                font-size: 0.7rem; 
                color: #d4d4d4; 
                background: #1e1e1e; 
                padding: 4px 8px; 
                height: 40px; 
                width: 280px;
                overflow: hidden; 
                display: flex; 
                flex-direction: column; 
                justify-content: flex-end; 
                border-radius: 6px; 
                border: 1px solid var(--border); 
                line-height: 1.2;
                margin-right: 10px;
                box-shadow: inset 0 0 5px rgba(0,0,0,0.5);
                cursor: pointer;" onclick="switchTab('logs')" title="Cliquez pour voir tous les logs">
                <div style="opacity:0.5">...</div>
                <div style="opacity:0.75">SystÃ¨me prÃªt.</div>
                <div style="color:var(--primary)">En attente...</div>
            </div>

            <div id="stats-summary" style="font-size: 0.9rem; color: var(--text-muted)">

                <span id="stat-total-ads">0</span> annonces | <span id="stat-pending-ai"
                    style="color:var(--primary)">0</span> Ã  analyser
            </div>
            <div class="loader" id="global-loader"></div>
            <div style="display:flex; flex-direction:column; align-items:flex-end; position:relative;">
                <button class="btn-primary" onclick="runBatchAnalysis()">ğŸ¤– Analyser tout</button>
                <div id="ai-status-embedded" style="
                    display:none; 
                    margin-top: 5px; 
                    background: var(--card-bg); 
                    border: 1px solid var(--border); 
                    border-radius: 8px; 
                    padding: 8px; 
                    width: 300px; 
                    font-size: 0.75rem; 
                    position: absolute; 
                    top: 100%; 
                    right: 0; 
                    z-index: 1000; 
                    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                    backdrop-filter: blur(10px);">

                    <div
                        style="display:flex; justify-content:space-between; margin-bottom:5px; border-bottom:1px solid var(--border); padding-bottom:4px;">
                        <span id="ai-status-badge" style="font-weight:bold; color:var(--primary)">INITIALISATION</span>
                        <span style="cursor:pointer; color:var(--danger)" onclick="stopAiAnalysis()">ğŸ›‘ STOP</span>
                    </div>
                    <div
                        style="height:4px; background:var(--bg); border-radius:2px; overflow:hidden; margin-bottom:5px;">
                        <div id="ai-status-progress" style="height:100%; background:var(--primary); width:0%"></div>
                    </div>
                    <div id="ai-status-log"
                        style="max-height:60px; overflow-y:auto; font-family:monospace; color:var(--text-muted); line-height:1.2;">
                    </div>
                </div>
            </div>
            <button onclick="toggleTheme()"
                style="background:none; border:none; font-size:1.4rem; cursor:pointer">ğŸŒ“</button>
        </div>
    </header>


    <!-- Global Settings Modal -->
    <div id="global-settings-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px">
                <h2 style="margin:0">âš™ï¸ Configuration Globale</h2>
                <button class="btn-link" onclick="closeGlobalSettings()" style="font-size:1.5rem">&times;</button>
            </div>

            <div class="form-group">
                <label>ğŸ¤– ClÃ© API Google Gemini (IA)</label>
                <input type="password" id="global-google-api-key" placeholder="AIzaSy..." style="width:100%">
            </div>

            <div class="form-group">
                <label>ğŸ“¢ Webhook Discord (Notifications)</label>
                <div style="display:flex; gap:10px">
                    <input type="text" id="global-discord-webhook" placeholder="https://discord.com/..." style="flex:1">
                    <button class="btn-primary"
                        style="padding:0.5rem 1rem; background:var(--bg); border:1px solid var(--border)"
                        onclick="testDiscord()">Tester</button>
                </div>
            </div>

            <hr style="border:none; border-top:1px solid var(--border); margin:20px 0">

            <h3 style="margin-bottom:15px">Valeurs par dÃ©faut pour les nouvelles veilles</h3>

            <div class="form-group">
                <label>ğŸ¤– Instructions IA par dÃ©faut</label>
                <textarea id="global-default-ai-context" rows="3"
                    placeholder="Ex: Priorise les annonces avec facture et garantie..."></textarea>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px">
                <div class="form-group">
                    <label>ğŸ”„ Mode d'actualisation</label>
                    <select id="global-default-refresh-mode">
                        <option value="manual">Manuel</option>
                        <option value="auto">Automatique</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>â±ï¸ Intervalle (min)</label>
                    <input type="number" id="global-default-refresh-interval" value="60">
                </div>
            </div>

            <div class="form-group">
                <label>ğŸŒ Plateformes par dÃ©faut</label>
                <div style="display:flex; gap:15px; margin-top:10px">
                    <label style="display:flex; gap:5px; cursor:pointer"><input type="checkbox" id="global-default-lbc"
                            checked> LBC</label>
                    <label style="display:flex; gap:5px; cursor:pointer"><input type="checkbox"
                            id="global-default-ebay"> eBay</label>
                    <label style="display:flex; gap:5px; cursor:pointer"><input type="checkbox"
                            id="global-default-vinted"> Vinted</label>
                </div>
            </div>

            <div style="margin-top:30px; display:flex; gap:10px">
                <button class="btn-primary" style="flex:1" onclick="saveGlobalSettings()">Enregistrer tout</button>
                <button class="btn-link" onclick="closeGlobalSettings()">Annuler</button>
            </div>
        </div>
    </div>
    <div class="tabs">
        <div class="tab active" onclick="switchTab('live')">ğŸ” Recherche</div>
        <div class="tab" onclick="switchTab('watches')">ğŸ“¡ Mes Veilles</div>
        <div class="tab" onclick="switchTab('logs')">ğŸ–¥ï¸ Logs SystÃ¨me</div>
    </div>

    <div class="container">
        <!-- --- VIEW 1: LIVE SEARCH --- -->
        <section id="view-live" class="view-section active">
            <section class="search-container">
                <div class="search-title">ğŸš€ Nouvelle Recherche</div>

                <div class="form-grid">
                    <div class="form-group multi-keywords">
                        <label>Mots-clÃ©s</label>
                        <div class="keyword-input-wrapper">
                            <input type="text" id="keyword-input" placeholder="Ajouter (ex: VTT, iPhone...)"
                                onkeypress="if(event.key==='Enter') addKeyword()">
                            <button class="btn-primary" onclick="addKeyword()"
                                style="padding:0 1.2rem; border-radius:8px">+</button>
                        </div>
                        <div class="keywords-list" id="keywords-list"></div>
                    </div>

                    <div class="form-group">
                        <label>CatÃ©gorie</label>
                        <select id="category-select">
                            <option value="0">Toutes</option>
                        </select>
                    </div>

                    <div class="form-group multi-locations"
                        style="grid-column: 1 / -1; background: var(--card-bg); padding: 15px; border-radius: 12px; border: 1px solid var(--border);">
                        <label>ğŸ“ Localisation(s)</label>
                        <div class="location-input-wrapper" style="display:flex; gap:10px; margin-top:10px">
                            <select id="loc-type" onchange="updateLocUI()" style="flex:1">
                                <option value="none">France EntiÃ¨re</option>
                                <option value="city">Ville + Rayon</option>
                                <option value="dept">DÃ©partement</option>
                                <option value="region">RÃ©gion</option>
                            </select>
                            <div id="loc-inputs" style="flex:2; display:flex; gap:10px">
                                <input type="text" id="loc-city" placeholder="Ville" style="flex:2; display:none"
                                    onkeypress="if(event.key==='Enter') addLocation()">
                                <input type="number" id="loc-radius" placeholder="Km" style="flex:1; display:none"
                                    value="10" onkeypress="if(event.key==='Enter') addLocation()">
                                <select id="loc-select" style="flex:2; display:none"></select>
                            </div>
                            <button class="btn-primary" onclick="addLocation()"
                                style="padding:0 1.2rem; border-radius:8px">+</button>
                        </div>
                        <div class="locations-list" id="locations-list"
                            style="display:flex; flex-wrap:wrap; gap:10px; margin-top:15px"></div>
                    </div>

                    <div class="form-group">
                        <label>Prix (â‚¬)</label>
                        <div style="display:flex; gap:10px">
                            <input type="number" id="price-min" placeholder="Min" style="flex:1">
                            <input type="number" id="price-max" placeholder="Max" style="flex:1">
                        </div>
                    </div>

                    <div class="form-group" style="flex-direction: row; gap: 20px; align-items: center;">
                        <label class="toggle-group">
                            <span class="switch"><input type="checkbox" id="delivery-toggle"><span
                                    class="slider"></span></span>
                            <span>Livraison</span>
                        </label>
                    </div>

                    <div class="form-group">
                        <label>Vendeur</label>
                        <select id="owner-select">
                            <option value="all">Tous</option>
                            <option value="private">Particuliers</option>
                            <option value="pro">Pros</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Tri</label>
                        <select id="sort-select">
                            <option value="newest">Plus rÃ©cent</option>
                            <option value="relevance">Pertinence</option>
                        </select>
                    </div>

                    <div class="form-group"
                        style="grid-column: 1 / -1; background: var(--bg); padding: 15px; border-radius: 12px; border: 1px solid var(--border);">
                        <label>ğŸ•’ Mode d'actualisation de la veille</label>
                        <div style="display:flex; gap:20px; margin-top:10px; align-items:center">
                            <select id="refresh-mode" style="flex:1"
                                onchange="document.getElementById('refresh-interval-group').style.display = (this.value==='auto'?'block':'none')">
                                <option value="manual">Manuel (via bouton)</option>
                                <option value="auto">Automatique (pÃ©riodique)</option>
                                <option value="none">Statique (pas d'actualisation)</option>
                            </select>
                            <div id="refresh-interval-group" style="flex:1; display:none">
                                <div style="display:flex; align-items:center; gap:10px">
                                    <input type="number" id="refresh-interval" value="60" style="width:80px">
                                    <span style="font-size:0.8rem">minutes</span>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top:15px; padding-top:10px; border-top:1px solid rgba(255,255,255,0.05)">
                            <label class="toggle-group"
                                title="Active des dÃ©lais alÃ©atoires et rÃ©cupÃ¨re plus de pages (Anti-Ban)">
                                <span class="switch"><input type="checkbox" id="deep-search-toggle"><span
                                        class="slider"></span></span>
                                <span style="font-weight:600; color:var(--primary)">ğŸ•µï¸ Mode Furtif (Veille
                                    Profonde)</span>
                            </label>
                            <p style="font-size:0.7rem; color:var(--text-muted); margin-top:4px">RÃ©cupÃ¨re jusqu'Ã  150
                                annonces (3 pages) avec des dÃ©lais de protection.</p>
                        </div>
                    </div>


                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>ğŸŒ Plateformes de recherche</label>
                        <div style="display:flex; gap:20px; margin-top:10px; flex-wrap:wrap">
                            <label class="checkbox-group">
                                <input type="checkbox" id="platform-lbc" checked> Leboncoin
                            </label>
                            <label class="checkbox-group">
                                <input type="checkbox" id="platform-ebay"> eBay
                            </label>
                            <label class="checkbox-group">
                                <input type="checkbox" id="platform-vinted"> Vinted
                            </label>
                        </div>
                    </div>

                    <div class="form-group" style="grid-column: 1 / -1;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px">
                            <label>ğŸ¤– Instructions IA</label>
                            <button type="button" class="btn-link"
                                style="font-size:0.75rem; color:var(--primary); padding:2px 8px"
                                onclick="openGemBuilder()">âœ¨ Aide Gem</button>
                        </div>
                        <textarea id="ai-context" placeholder="Ex: 'Cherche un vÃ©lo sans rouille, cadre alu.' "
                            style="min-height: 60px;"></textarea>
                    </div>
                </div>
            </section>

            <button class="btn-search" onclick="performSearch()">LANCER LA RECHERCHE</button>
            <button class="btn-link" onclick="createWatchFromSearch()" style="width:100%; margin-top:10px">ğŸ’¾
                Enregistrer cette veille</button>

            <div class="results-header" style="margin-top:2rem">
                <h2 id="results-count">RÃ©sultats</h2>
                <div style="color: var(--text-muted); font-size: 0.9rem" id="last-update">PrÃªt</div>
            </div>

            <div class="ads-grid" id="ads-grid-live">
                <div style="grid-column: 1/-1; text-align: center; padding: 4rem; color: #AAA;">
                    <p>DÃ©finissez vos filtres ci-dessus.</p>
                </div>
            </div>
        </section>

        <!-- --- VIEW 2: WATCHES --- -->
        <section id="view-watches" class="view-section">
            <div class="results-header">
                <h2>ğŸ“¡ Vos Veilles Actives</h2>
            </div>

            <div id="watch-stats-bar"
                style="display:flex; gap:20px; margin-bottom:20px; background:var(--card-bg); padding:1.2rem; border-radius:16px; border:1px solid var(--glass-border); backdrop-filter:var(--blur)">
                <div class="stat-pill"><b>Total :</b> <span id="stat-total-watches">0</span> veilles</div>
                <div class="stat-pill"><b>Annonces :</b> <span id="stat-total-ads">0</span></div>
                <div class="stat-pill" style="background:var(--primary-soft); color:var(--primary)"><b>Nouveau :</b>
                    <span id="stat-new-ads">0</span> âœ¨
                </div>
            </div>

            <div id="active-watches-list"
                style="display:grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap:20px"></div>
        </section>

        <!-- --- VIEW 3: SYSTEM LOGS --- -->
        <section id="view-logs" class="view-section">
            <div class="results-header">
                <h2>ğŸ–¥ï¸ Console de Surveillance</h2>
                <div style="display:flex; gap:10px">
                    <button class="btn-primary" onclick="copySystemLogs()"
                        style="padding: 5px 15px; font-size: 0.9rem;">ğŸ“‹ Copier tout</button>
                    <button class="btn-link" onclick="clearSystemLogs()" style="color:var(--danger)">ğŸ—‘ï¸
                        Effacer</button>
                </div>
            </div>

            <div id="full-system-log-container" style="
                    background: #1e1e1e; 
                    color: #d4d4d4; 
                    font-family: 'Consolas', 'Monaco', monospace; 
                    padding: 15px; 
                    border-radius: 12px; 
                    height: 600px; 
                    overflow-y: auto; 
                    border: 1px solid var(--border);
                    box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
                ">
                <div style="color: #6a9955; margin-bottom: 10px;">// Logs de l'application LBC Finder...</div>
                <div id="full-system-logs"></div>
            </div>
        </section>

        <!-- --- DASHBOARD --- -->
        <section id="view-dashboard" class="view-section">
            <div class="results-header"
                style="background: var(--card-bg); padding: 1.5rem; border-radius: 20px; border: 1px solid var(--border); margin-bottom: 2rem; display: block;">
                <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                    <h2 id="current-search-name" style="color:var(--primary); margin:0;">Dashboard</h2>
                    <div style="display:flex; gap:10px">
                        <button class="btn-primary" style="padding: 0.5rem 1rem; background: var(--success);"
                            onclick="refreshCurrentSearch()" id="btn-refresh-dashboard">ğŸ”„ Actualiser
                            <div class="loader" id="refresh-loader"
                                style="display:none; width:12px; height:12px; border-width:2px; margin-left:5px"></div>
                        </button>
                        <button class="btn-link" style="padding: 0.5rem 1rem; color: var(--danger);"
                            onclick="clearAllAnalyses()">ğŸ—‘ï¸ Suppr. Analyses</button>
                        <button class="btn-link" style="padding: 0.5rem 1rem" onclick="openSearchSettings()">âš™ï¸
                            ParamÃ¨tres</button>
                        <button class="btn-primary" style="padding: 0.5rem 1rem" onclick="openManualAdModal()">ğŸ”—
                            Ajouter un lien</button>
                        <button class="btn-primary" style="padding: 0.5rem 1rem" onclick="switchTab('live')">ğŸš€
                            Nouveau</button>
                        <button class="btn-link" style="padding: 0.5rem 1rem" onclick="switchTab('watches')">â¬…ï¸
                            Retour</button>
                    </div>
                </div>

                <div
                    style="display:flex; justify-content:space-between; align-items:center; margin-top:20px; border-top: 1px solid var(--border); padding-top: 15px;">
                    <div id="current-search-stats" style="color:var(--text-muted); font-size:0.9rem; font-weight:600;">
                        Statistiques...</div>
                    <div style="display:flex; gap:15px; align-items:center">
                        <div class="view-toggles"
                            style="display:flex; background:var(--bg); padding:3px; border-radius:8px">
                            <button id="btn-view-grid" class="view-btn active"
                                style="padding:4px 12px; border:none; border-radius:6px; cursor:pointer"
                                onclick="setViewMode('grid')">GRID</button>
                            <button id="btn-view-list" class="view-btn"
                                style="padding:4px 12px; border:none; border-radius:6px; cursor:pointer"
                                onclick="setViewMode('list')">LIST</button>
                        </div>
                        <select id="dashboard-sort" onchange="runDashboardSort()"
                            style="padding:5px 10px; font-size:0.8rem">
                            <option value="date-desc">ğŸ•’ Plus rÃ©cent</option>
                            <option value="price-asc">ğŸ’° Prix croissant</option>
                            <option value="score-desc">â­ Meilleur score IA</option>
                        </select>
                    </div>
                </div>

                <div id="update-alert"
                    style="display:none; background:var(--success); color:white; padding:12px 20px; border-radius:12px; margin-top:15px; font-weight:700; cursor:pointer; text-align:center;"
                    onclick="loadHistory(currentSearchName)">
                    âœ¨ <span id="update-alert-text">Nouvelles annonces trouvÃ©es ! Cliquez pour rafraÃ®chir.</span>
                </div>

                <div id="tag-cloud-container"
                    style="margin-top:20px; padding-top:15px; border-top: 1px dashed var(--border); display:none;">
                    <div
                        style="font-size:0.7rem; color:var(--text-muted); margin-bottom:10px; font-weight:800; text-transform:uppercase;">
                        ğŸ·ï¸ Filtres intelligents (mots-clÃ©s extraits) :</div>
                    <div id="tag-cloud" style="display:flex; flex-wrap:wrap; gap:10px;"></div>
                </div>
            </div>

            <div
                style="display:flex; justify-content: space-between; align-items: center; margin-bottom:20px; border-bottom:1px solid var(--border)">
                <div style="display:flex; gap:10px;">
                    <div class="tab active subtab" onclick="switchSubTab('history')">ğŸ“¦ Annonces</div>
                    <div class="tab subtab" onclick="switchSubTab('top')">ğŸ† Top Affaires IA</div>
                    <div class="tab subtab" onclick="switchSubTab('map')">ğŸ—ºï¸ Carte</div>
                    <div class="tab subtab" onclick="switchSubTab('trends')">ğŸ“Š MarchÃ©</div>
                </div>
                <button id="btn-filter-manual" class="btn-link" onclick="toggleManualFilter()"
                    style="margin-bottom: 5px; color: #7C3AED; border-color: #7C3AED; font-weight:800;">ğŸ“ Mes Ajouts
                    Manuels</button>
            </div>

            <div id="sub-history" class="sub-view active">
                <div class="ads-grid" id="ads-grid-history"></div>
            </div>
            <div id="sub-top" class="sub-view" style="display:none">
                <div id="top-ai-header" class="ai-summary-box"
                    style="margin-bottom: 20px; display:none; position: relative;">
                    <button class="btn-primary"
                        style="position: absolute; top: 15px; right: 15px; padding: 5px 12px; font-size: 0.8rem;"
                        onclick="openExportModal()">ğŸ“‹ Copier Top 10</button>
                    <div id="top-ai-header-content"></div>
                </div>
                <div class="ads-grid" id="ads-grid-top"></div>
            </div>
            <div id="sub-map" class="sub-view" style="display:none">
                <div id="map"></div>
            </div>
            <div id="sub-trends" class="sub-view" style="display:none">
                <div class="chart-container"><canvas id="priceChart"></canvas></div>
            </div>
        </section>
    </div>

    <!-- Modals -->
    <div class="compare-bar" id="compare-bar" style="gap:15px; padding: 10px 25px;">
        <span id="compare-text" style="font-weight:700">0 sÃ©lectionnÃ©e(s)</span>
        <button class="btn-link" onclick="selectAllVisible()" style="color:white; font-size:0.8rem">Tout
            sÃ©lectionner</button>
        <button class="btn-primary" onclick="runComparison()" style="white-space:nowrap">ğŸ“Š Comparer</button>
        <button class="btn-primary" onclick="hideSelectedAds()" style="background:var(--danger); white-space:nowrap">ğŸ—‘ï¸
            Masquer</button>
        <div
            style="flex:1; display:flex; gap:10px; background: rgba(255,255,255,0.1); padding: 5px 10px; border-radius: 8px;">
            <input type="text" id="selective-prompt" placeholder="Prompt IA spÃ©cial..."
                style="flex:1; background:none; border:none; color:white; outline:none; font-size:0.85rem">
            <button class="btn-primary" onclick="runSelectiveAnalysis()"
                style="background:var(--success); padding: 4px 10px; font-size:0.8rem">ğŸ¤– Analyser</button>
        </div>
        <button class="btn-link" onclick="clearSelection()" style="color:white; font-size:1.2rem">Ã—</button>
    </div>

    <button class="btn-primary" onclick="clearSelectedAnalyses()"
        style="background:var(--danger); padding: 4px 10px; font-size:0.8rem">ğŸ—‘ï¸ Supprimer Analyses</button>
    <button style="background:none; border:none; color:white; cursor:pointer; font-weight:600"
        onclick="clearSelection()">Vider âœ•</button>
    </div>

    <div class="modal" id="compare-modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">Ã—</span>
            <div id="compare-result"></div>
        </div>
    </div>

    <div class="modal" id="gem-builder-modal">
        <div class="modal-content">
            <span class="close" onclick="closeGemModal()">Ã—</span>
            <h3>âœ¨ Assistant de RÃ©daction</h3>
            <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:1.5rem">Quel est le but prÃ©cis de votre
                recherche ? (ex: "PC Gamer pour 800â‚¬, pas de composants trop vieux")</p>
            <input type="text" id="gem-goal" placeholder="Votre objectif..." style="width:100%; margin-bottom:15px">
            <button class="btn-search" onclick="buildGem()">GÃ©nÃ©rer l'instruction expert</button>
            <div id="gem-loading" style="display:none; text-align:center; padding:1.5rem">
                <div class="loader" style="display:inline-block"></div>
            </div>
            <div id="gem-preview"
                style="display:none; margin-top:20px; background:var(--bg); padding:1rem; border-radius:12px; font-size:0.9rem; border:1px dashed var(--border)">
            </div>
            <button id="btn-use-gem" class="btn-primary" style="display:none; width:100%; margin-top:15px"
                onclick="useGem()">Utiliser cette instruction</button>
        </div>
    </div>

    <div class="modal" id="export-modal">
        <div class="modal-content">
            <span class="close" onclick="document.getElementById('export-modal').classList.remove('show')">Ã—</span>
            <h3>ğŸ“‹ Export Top 10 Affaires</h3>
            <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:1.5rem">Voici votre sÃ©lection prÃªte Ã 
                Ãªtre copiÃ©e-collÃ©e.</p>

            <div style="margin-bottom: 15px;">
                <label class="toggle-group">
                    <span class="switch"><input type="checkbox" id="export-include-ai" checked
                            onchange="generateExportText()"><span class="slider"></span></span>
                    <span>Inclure les notes de l'IA</span>
                </label>
            </div>

            <textarea id="export-text"
                style="width:100%; height:300px; font-family:monospace; font-size:0.85rem; margin-bottom:15px"
                readonly></textarea>

            <button class="btn-primary" style="width:100%" onclick="copyToClipboard()">Copier dans le
                presse-papier</button>
        </div>
    </div>

    <!-- Help Modal -->
    <div class="modal" id="help-modal">
        <div class="modal-content" style="max-width: 800px; padding: 2rem;">
            <span class="close" onclick="closeHelpModal()">Ã—</span>
            <h2 style="color:var(--primary); margin-bottom: 20px;">ğŸ“˜ Guide d'Utilisation</h2>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:30px; text-align: left;">
                <div class="help-section">
                    <h3 style="margin-bottom:10px">ğŸ“¡ CrÃ©er une veille</h3>
                    <p style="font-size:0.9rem; color:var(--text-muted); line-height:1.5">
                        Utilisez l'onglet <b>"Nouveau"</b>. Tapez votre recherche en langage naturel (ex: <i>"VTT
                            Ã©lectrique autour de Rennes max 1500â‚¬"</i>).
                        Vous pouvez ajouter plusieurs villes, dÃ©partements ou rÃ©gions pour une mÃªme veille.
                    </p>
                    <ul style="font-size:0.85rem; margin-top:10px; padding-left:20px;">
                        <li><b>Manuel :</b> Mise Ã  jour quand vous le dÃ©cidez.</li>
                        <li><b>Auto :</b> L'outil scanne tout seul pÃ©riodiquement.</li>
                        <li><b>Mode Furtif :</b> Plus lent, mais Ã©vite les blocages LBC.</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3 style="margin-bottom:10px">ğŸ¤– Intelligence Artificielle</h3>
                    <p style="font-size:0.9rem; color:var(--text-muted); line-height:1.5">
                        L'IA analyse vos annonces pour dÃ©tecter les pÃ©pites ou les arnaques.
                    </p>
                    <ul style="font-size:0.85rem; margin-top:10px; padding-left:20px;">
                        <li><b>Score :</b> Une note sur 10 basÃ©e sur le rapport qualitÃ©/prix.</li>
                        <li><b>RÃ©sumÃ© :</b> Points forts (âœ…) et points faibles (âŒ).</li>
                        <li><b>NÃ©gociation :</b> GÃ©nÃ¨re un message type pour baisser le prix.</li>
                        <li><b>Comparaison :</b> SÃ©lectionnez 2+ annonces et comparez-les.</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3 style="margin-bottom:10px">ğŸ“¦ Gestion des annonces</h3>
                    <p style="font-size:0.9rem; color:var(--text-muted); line-height:1.5">
                        Maintenez votre dashboard propre.
                    </p>
                    <ul style="font-size:0.85rem; margin-top:10px; padding-left:20px;">
                        <li><b>ğŸ—‘ï¸ Masquer :</b> Supprime visuellement l'annonce.</li>
                        <li><b>ğŸ”— Ajouter :</b> Pour forcer une annonce via son URL.</li>
                        <li><b>ğŸ“‰ Baisse :</b> DÃ©tectÃ© automatiquement si le prix change.</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3 style="margin-bottom:10px">ğŸ“¢ Notifications</h3>
                    <p style="font-size:0.9rem; color:var(--text-muted); line-height:1.5">
                        Reliez un Webhook Discord dans les paramÃ¨tres de la veille pour recevoir les alertes dÃ¨s qu'une
                        pÃ©pite (score > 8) est trouvÃ©e !
                    </p>
                </div>
            </div>

            <button class="btn-primary" style="margin-top:30px; width:100%" onclick="closeHelpModal()">C'est compris
                !</button>
        </div>
    </div>


    <!-- AI Chat Window -->
    <div id="ai-chat-bubble" onclick="toggleChat()">ğŸ¤–</div>
    <!-- AI Status Overlay -->
    <!-- AI Status Overlay REMOVED. Replaced by fixed bottom panel -->
    <!-- AI Log Panel REMOVED (Moved to Header) -->

    <div id="ai-chat-window">
        <div id="ai-chat-header">
            <span>ğŸ¤– Assistant Gemini</span>
            <span onclick="toggleChat()" style="cursor:pointer">Ã—</span>
        </div>
        <div id="ai-chat-messages">
            <div class="message ai">Bonjour ! Je suis prÃªt Ã  discuter de vos trouvailles. Quel objet vous intÃ©resse
                aujourd'hui ?</div>
        </div>
        <div id="ai-chat-input-area">
            <input type="text" id="ai-chat-input" placeholder="Posez votre question..."
                onkeypress="if(event.key==='Enter') sendChatMessage()">
            <button onclick="sendChatMessage()">ğŸš€</button>
        </div>
    </div>


    <!-- Feedback / Bug Report Modal -->
    <div id="feedback-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
                <h2 style="margin:0">ğŸ’¡ AmÃ©liorer l'application</h2>
                <span class="close" onclick="closeFeedbackModal()">Ã—</span>
            </div>
            <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:20px">
                Une idÃ©e ? Un bug ? DÃ©crivez-le ci-dessous pour aider Ã  amÃ©liorer l'outil.
            </p>

            <div class="form-group">
                <label>Type</label>
                <div style="display:flex; gap:20px; margin-top:5px">
                    <label style="cursor:pointer; display:flex; gap:8px; align-items:center">
                        <input type="radio" name="feedback-type" value="bug" checked> ğŸ› Bug
                    </label>
                    <label style="cursor:pointer; display:flex; gap:8px; align-items:center">
                        <input type="radio" name="feedback-type" value="feature"> âœ¨ IdÃ©e / FonctionnalitÃ©
                    </label>
                    <label style="cursor:pointer; display:flex; gap:8px; align-items:center">
                        <input type="radio" name="feedback-type" value="other"> ğŸ’¬ Autre
                    </label>
                </div>
            </div>

            <div class="form-group" style="margin-top:15px">
                <label>Description</label>
                <textarea id="feedback-msg" rows="5" placeholder="DÃ©crivez le problÃ¨me ou votre idÃ©e..."
                    style="width:100%"></textarea>
            </div>

            <div style="display:flex; gap:10px; margin-top:20px">
                <button class="btn-primary" style="flex:1" onclick="submitFeedback()">Envoyer</button>
                <button class="btn-link" onclick="closeFeedbackModal()">Fermer</button>
            </div>
        </div>
    </div>

    <!-- Manual Ad Modal -->
    <div class="modal" id="manual-ad-modal">
        <div class="modal-content">
            <span class="close" onclick="document.getElementById('manual-ad-modal').classList.remove('show')">Ã—</span>
            <h3>ğŸ”— Ajouter manuellement une annonce</h3>
            <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:1.5rem">Collez le lien Leboncoin pour
                l'ajouter Ã  ce dashboard.</p>
            <input type="text" id="manual-ad-url" placeholder="https://www.leboncoin.fr/..."
                style="width:100%; margin-bottom:15px">
            <button class="btn-primary" style="width:100%" onclick="submitManualAd()">Ajouter l'annonce</button>
        </div>
    </div>

    <div id="notification">Notification</div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="/static/js/main.js"></script>
    <div class="modal" id="search-settings-modal">
        <div class="modal-content" style="max-width:600px">
            <span class="close"
                onclick="document.getElementById('search-settings-modal').classList.remove('show')">Ã—</span>
            <h3>âš™ï¸ ParamÃ¨tres de la veille</h3>
            <p style="font-size:0.8rem; color:var(--text-muted); margin-bottom:20px">Modifiez ici les rÃ©glages
                spÃ©cifiques Ã  "<b><span id="settings-watch-name"></span></b>".</p>

            <div class="form-group">
                <label>ğŸ” Mots-clÃ©s / RequÃªte</label>
                <textarea id="settings-query-text" rows="2" placeholder="Ex: vÃ©lo vtt rockrider"></textarea>
            </div>

            <div class="form-group">
                <label>ğŸ¤– Instructions IA Globales</label>
                <textarea id="settings-ai-context" rows="6"
                    placeholder="Instructions pour le rÃ©sumÃ© et le score..."></textarea>
            </div>

            <div class="form-group">
                <label>ğŸ“¢ Webhook Discord SpÃ©cifique (Optionnel)</label>
                <input type="text" id="settings-discord-webhook" placeholder="https://discord.com/api/webhooks/..."
                    style="width:100%">
                <p style="font-size:0.75rem; color:var(--text-muted); margin-top:5px">Laissez vide pour utiliser le
                    webhook global.</p>
            </div>

            <div class="form-group">
                <label>ğŸ•’ Mode d'actualisation</label>
                <div style="display:flex; gap:10px; align-items:center">
                    <select id="settings-refresh-mode" style="flex:1"
                        onchange="document.getElementById('settings-interval-group').style.display = (this.value==='auto'?'block':'none')">
                        <option value="manual">Manuel</option>
                        <option value="auto">Automatique</option>
                        <option value="none">Statique</option>
                    </select>
                    <label class="toggle-group"
                        style="background:var(--bg); border:1px solid var(--border); padding:5px 12px; border-radius:8px">
                        <span class="switch"><input type="checkbox" id="settings-deep-search"><span
                                class="slider"></span></span>
                        <span style="font-size:0.85rem">ğŸ•µï¸ Furtif</span>
                    </label>
                </div>
            </div>


            <div class="form-group">
                <label>ğŸŒ Plateformes actives</label>
                <div style="display:flex; gap:15px; margin-top:5px">
                    <label class="checkbox-group"><input type="checkbox" id="settings-platform-lbc"> LBC</label>
                    <label class="checkbox-group"><input type="checkbox" id="settings-platform-ebay"> eBay</label>
                    <label class="checkbox-group"><input type="checkbox" id="settings-platform-vinted"> Vinted</label>
                </div>
            </div>

            <div id="settings-interval-group" class="form-group" style="display:none">
                <label>Intervalle (minutes)</label>
                <input type="number" id="settings-refresh-interval" value="60">
            </div>

            <hr style="border:none; border-top:1px solid var(--border); margin:20px 0">

            <p style="font-size:0.75rem; color:var(--text-muted); margin-top:20px; font-style: italic;">
                Note : Si un champ est laissÃ© vide, la configuration globale sera utilisÃ©e.
            </p>

            <div style="margin-top:20px; display:flex; gap:10px">
                <button class="btn-primary" style="flex:1" onclick="saveSearchSettings()">Enregistrer les
                    modifications</button>
                <button class="btn-link"
                    onclick="document.getElementById('search-settings-modal').classList.remove('show')">Annuler</button>
            </div>
        </div>
    </div>
</body>

</html>